<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .profile-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .company-card {
            margin-bottom: 20px;
        }
        .error-message {
            text-align: center;
            color: red;
        }
    </style>
</head>
<body>
<div class="profile-container border">
    <h2>Профиль</h2>
    <div id="profile-info" class="mb-4">
        <p><strong>Почта:</strong> <span id="user-email">Загрузка...</span></p>
        <p><strong>ФИО:</strong> <span id="user-fullname">Загрузка...</span></p>
    </div>
    <h3>Компании</h3>
    <div id="companies-list" class="mb-4">
            
    </div>
    <button id="logout-button" class="btn btn-danger w-100">Выйти</button>
    <p id="error-message" class="text-danger text-center mt-3"></p>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Отправить отчет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Тип отчета</label>
                        <input type="text" class="form-control" id="reportType" name="reportType" required>
                    </div>
                    <div class="mb-3">
                        <label for="reportFile" class="form-label">Файлы отчета</label>
                        <input type="file" class="form-control" id="reportFile" name="reportFile" accept=".pdf, .docx" multiple required>
                    </div>
                    <button type="submit" class="btn btn-primary">Отправить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    async function refreshToken() {
        const response = await fetch("http://localhost:5212/api/user/refresh-token", {
            method: "POST",
            credentials: "include", // Отправка Cookies
        });

        if (response.ok) {
            console.log("Токен успешно обновлен.");
        } else {
            const errorDetails = await response.text(); 
            console.error("Ошибка при обновлении токена:", errorDetails);
            document.getElementById("error-message").textContent = "Не удалось обновить токен. Перезайдите в систему.";
            throw new Error("Токен истёк. Перезайдите в систему.");
        }
    }


    async function getUserProfile() {
        try {
            await refreshToken(); // Сначала обновляем токен
            const response = await fetch("http://localhost:5212/api/user/profile", {
                method: "GET",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                document.getElementById("user-email").textContent = user.email;
                document.getElementById("user-fullname").textContent = user.fullName;
                await loadUserCompanies(user.userId);
            } else {
                throw new Error("Не удалось загрузить профиль пользователя.");
            }
        } catch (error) {
            document.getElementById("error-message").textContent = error.message;
        }
    }

    async function loadUserCompanies(userId) {
        console.log(userId);
        const response = await fetch(`http://localhost:5212/api/user/companies/${userId}`, {
            method: "GET",
            credentials: "include",
            headers: {
                "Content-Type": "application/json"
            }
        });

        if (response.ok) {
            const companies = await response.json();
            console.log("Полученные компании:", companies);

            if (companies.length === 0) {
                document.getElementById("companies-list").innerHTML = "<p>У вас нет компаний.</p>";
                return;
            }
            const companiesList = document.getElementById("companies-list");
            companiesList.innerHTML = ""; // Очищаем старые данные, если они есть

            companies.forEach(company => {
                const companyCard = document.createElement("div");
                companyCard.classList.add("card", "company-card");

                console.log(company.сompanyName, company.address, company.taxPayerID);

                companyCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${company.companyName}</h5>
                        <p class="card-text">${company.address}</p>
                        <button class="btn btn-primary" onclick="openReportModal(${company.taxPayerID})">Отправить отчет</button>
                    </div>
                `;

                companiesList.appendChild(companyCard);
            });
        } else {
            document.getElementById("error-message").textContent = "Не удалось загрузить компании.";
        }
    }

    async function openReportModal(taxPayerID) {
        const modal = new bootstrap.Modal(document.getElementById('reportModal'));
        modal.show();

        const form = document.getElementById('reportForm');
        form.onsubmit = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const files = document.getElementById('reportFile').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('reportFiles', files[i]);
            }

            // Добавляем taxPayerID в formData
            formData.append("TaxPayerID", taxPayerID);

            const response = await fetch("http://localhost:5212/api/reports/submit", {
                method: "POST",
                body: formData,
                credentials: "include"
            });

            if (response.ok) {
                alert("Отчет успешно отправлен.");
                reportModal.hide();
            } else {
                const errorDetails = await response.text();
                console.error("Ошибка при отправке отчета:", errorDetails);
                alert("Ошибка при отправке отчета: " + errorDetails);
            }
        };
    }



    // Функция для выхода из системы
    async function logout() {
        const response = await fetch("http://localhost:5212/api/auth/logout", {
            method: "POST",
            credentials: "include"
        });

        if (response.ok) {
            window.location.href = "/login.html"; // Перенаправление на страницу входа
        } else {
            document.getElementById("error-message").textContent = "Ошибка при выходе из системы.";
        }
    }

    // Обработчик событий
    document.addEventListener("DOMContentLoaded", getUserProfile);
    document.getElementById("logout-button").addEventListener("click", logout);
</script>
</body>
</html>
